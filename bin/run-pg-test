#!/bin/bash

# Based on https://gist.github.com/petere/6023944

set -eux

apt-get update
packages="postgresql-$PGVERSION postgresql-server-dev-$PGVERSION postgresql-common postgresql-$PGVERSION-pgtap"
apt-get -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" install -y $packages

status=0
pg_createcluster --start $PGVERSION test -p 55435 -- -A trust
make all PG_CONFIG=/usr/lib/postgresql/$PGVERSION/bin/pg_config
make install PG_CONFIG=/usr/lib/postgresql/$PGVERSION/bin/pg_config
PGPORT=55435 make installcheck PGUSER=postgres PG_CONFIG=/usr/lib/postgresql/$PGVERSION/bin/pg_config || status=$?

if test -f regression.diffs; then cat regression.diffs; fi
exit $status
